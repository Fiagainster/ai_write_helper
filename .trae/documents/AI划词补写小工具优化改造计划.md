# AI划词补写小工具优化改造计划（基于现有架构）

## 一、优化原则

1. **基于现有架构**：不进行大规模重构，保持现有代码结构稳定
2. **聚焦核心问题**：只针对写入模式和监听机制的关键问题进行优化
3. **最小化变更**：修改尽量少的代码，确保改造后的功能稳定可靠
4. **保持向后兼容**：确保现有配置和功能不受影响

## 二、具体改造计划

### 1. 改进写入模式

**当前问题**：
- 默认使用完整重写模式，会替换配置中指定文档的所有内容
- 对于正在编辑的文档来说，这种写入方式风险高

**改进方案**：
- 将默认写入模式改为**增量模式**，但保持现有API不变
- 优化增量写入逻辑，确保内容追加的正确性
- 保留完整重写模式作为可选功能

**具体修改**：
1. **修改`monitor.py`**：
   - 将`_handle_selection_enter`方法中的写入模式参数从`incremental=False`改为`incremental=True`
   - 位置：第216-220行
   - 影响：所有AI补写操作默认使用增量模式

2. **优化`document_service.py`**：
   - 检查并优化`_write_text_file`方法的增量写入逻辑
   - 检查并优化`_write_docx_file`方法的增量写入逻辑
   - 确保增量写入时不会破坏原有文档结构

**预期效果**：
- 生成的内容会自动追加到文档末尾，而非替换整个文档
- 降低用户使用风险，不用担心丢失原有内容
- 保持现有API不变，确保向后兼容

### 2. 优化全局监听机制

**当前问题**：
- 全局监听在某些应用中可能无法正常工作
- 选中文本获取方式可靠性不高
- 可能干扰用户的正常操作

**改进方案**：
- 优化现有监听逻辑，提高可靠性
- 改进选中文本获取方式，减少干扰
- 添加简单的重试机制

**具体修改**：
1. **优化`monitor.py`中的监听逻辑**：
   - 改进`_on_mouse_click`方法，添加简单的防抖逻辑
   - 优化`_on_key_press`方法，确保Enter键检测的准确性
   - 位置：第119-171行

2. **改进选中文本获取方式**：
   - 优化`_get_selected_text`方法，添加重试机制（最多重试2次）
   - 优化剪贴板操作，增加适当的延迟，确保内容被正确复制
   - 位置：第235-318行

3. **添加错误处理**：
   - 在`_handle_selection_enter`方法中添加更详细的错误处理
   - 位置：第173-234行

**预期效果**：
- 提高监听机制的可靠性，减少漏触发和误触发
- 改进选中文本获取的成功率
- 减少对用户正常操作的干扰
- 保持现有架构不变，确保稳定可靠

## 三、实施计划

### 第一阶段：改进写入模式（1天）
1. 修改`monitor.py`中的写入模式默认参数
2. 优化`document_service.py`中的增量写入逻辑
3. 测试不同文档格式的增量写入效果

### 第二阶段：优化全局监听机制（1天）
1. 优化监听逻辑，添加防抖机制
2. 改进选中文本获取方式，添加重试机制
3. 测试监听机制在不同应用中的表现

### 第三阶段：测试与验证（1天）
1. 测试整体功能的稳定性
2. 测试在Word和MD文档中的表现
3. 修复发现的bug

## 四、预期成果

1. **支持Word和MD文档**：通过改进写入模式和监听机制，工具能够在Word和MD文档中正常工作
2. **提高写入安全性**：默认使用增量写入模式，避免替换整个文档，降低用户使用风险
3. **增强监听可靠性**：优化后的监听机制在各种应用中表现更稳定
4. **保持现有架构稳定**：不进行大规模重构，确保现有功能不受影响
5. **提高用户体验**：解决了用户最关心的核心问题，提高工具的可用性

通过以上保守的改造计划，我们可以在保持现有架构稳定的前提下，解决工具无法支持Word和MD文档的核心问题，提高工具的可用性和可靠性。